{"ast":null,"code":"//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { mapMutations, mapState } from \"vuex\";\nimport { playMusic, listenMusic } from \"@/utils/musicPlay\";\nimport { getDownloadUrl } from \"@/api/api\";\nimport { download } from \"@/utils/commonApi\"; // import { Loading } from \"element-ui\";\n\nexport default {\n  data() {\n    return {\n      // 试听歌曲\n      // audition:{\n      //   name: '卡农（经典钢琴版）', //歌曲名\n      //   artist: 'dylanf', //作者\n      //   // url: songUrlAdd,\n      //   url: `https://music.163.com/song/media/outer/url?id=478507889.mp3`,\n      //   cover: 'http://p2.music.126.net/fL7FAeRby1s7JreBqoOKjg==/109951165175371079.jpg',\n      //   // lrc: songlrc,\n      //   id: 478507889,\n      //   timer: true, //试听中添加，防止用户连点消耗性能，在添加播放列表方法中可使用到\n      // }\n      currentMusic: {},\n      //当前播放的音乐\n      aplayerDomLoading: false,\n      //是否正在获取aplayer播放器dom，有效利用资源，用于防卡顿一直获取\n      auditionDomLoading: false\n    };\n  },\n\n  computed: { ...mapState(\"aplayer\", [\"audio\", \"audition\", \"musicAudioStatu\"])\n  },\n\n  created() {\n    //监听按键\n    window.addEventListener(\"keydown\", this.operaMusic); //每隔几秒钟获取一次当前播放的音乐id\n\n    let playlist = setInterval(() => {\n      //判断上一次是否获取完毕\n      if (!this.aplayerDomLoading) {\n        this.aplayerDomLoading = true; // 开始获取状态\n\n        let aplayer = null;\n        this.musicAudioStatu === 0 ? aplayer = this.$refs.aplayer : aplayer = this.$refs.auditions; //判断获取哪个播放器的数据\n\n        let timeout = false; // 初始化超时标志为 false\n        // 设置一个超时定时器\n\n        let timeoutId = setTimeout(() => {\n          timeout = true;\n          this.aplayerDomLoading = false; // 超时时重置状态\n        }, 1000); // 设置超时时间，单位为毫秒，根据实际情况进行调整\n        // 检查超时标志和获取状态\n\n        if (aplayer && aplayer.currentMusic && !timeout) {\n          this.currentMusic = aplayer.currentMusic; //同步vuex中的正在播放歌曲的数据\n\n          this.changeVuexCurrentMusic(aplayer.currentMusic);\n          this.aplayerDomLoading = false;\n          clearTimeout(timeoutId); // 清除超时定时器\n        }\n      }\n    }, 2222);\n  },\n\n  beforeDestroy() {//销毁按键监听\n    // window.removeEventListener('keydown', this.operaMusic);\n  },\n\n  methods: { ...mapMutations(\"aplayer\", [\"deleteMUSIC\", \"deleteAUDITION\", \"changeAPLAYER\", \"changeCurrentPlayMusic\"]),\n\n    //播放指定歌曲\n    async playMusic(idx) {\n      //await,防止还未切换播放器就开始请求，使得aplayer出现undefine\n      if (this.musicAudioStatu === 1) {\n        await this.changeAPLAYER(0); //切换播放器\n      }\n\n      let aplayer = this.$refs.aplayer; //获取当前播放器\n      // console.log(aplayer.currentMusic.id)\n      // console.log(aplayer)\n\n      aplayer.switch(idx); //切换到播放当前下标的歌曲\n\n      aplayer.toggle(); //切换播放/暂停\n\n      this.currentMusic = aplayer.currentMusic; //将当前播放的音乐id记录\n      // console.log(this.currentMusicId)\n    },\n\n    //删除歌曲\n    deleteMusic(idx) {\n      // this.$store.commit('deleteMusic',idx)\n      this.deleteMUSIC(idx);\n    },\n\n    //试听的播放/暂停\n    async playAudition() {\n      if (this.musicAudioStatu === 0) {\n        await this.changeAPLAYER(1); //切换到试听播放器\n      }\n\n      let auditions = this.$refs.auditions; //获取当前播放器\n      // console.log(auditions)\n      // auditions.switch(0); //切换到播放当前下标的歌曲\n\n      auditions.toggle(); //切换播放/暂停\n\n      this.currentMusic = auditions.currentMusic; //将当前播放的音乐记录\n    },\n\n    //按空格键，对音乐进行播放或者暂停\n    operaMusic(event) {\n      // 首先判断事件目标是否为输入框\n      if (event.target.tagName.toLowerCase() !== \"input\") {\n        if (event.key === \" \") {\n          // console.log('按下了空格')\n          // console.log(this.musicAudioStatu)\n          if (this.musicAudioStatu === 0) {\n            //播放列表\n            let aplayer = this.$refs.aplayer; //获取当前播放器\n\n            aplayer.toggle(); //切换播放/暂停\n          } else {\n            let auditions = this.$refs.auditions; //获取当前播放器\n            // console.log(auditions)\n\n            auditions.toggle(); //切换播放/暂停\n          }\n        }\n      }\n    },\n\n    //删除试听\n    deleteAudition(idx) {\n      this.deleteAUDITION(idx);\n    },\n\n    //添加到播放列表\n    addListenMusic(songDetals) {\n      let that = this;\n      let songDetail = {\n        ar: [{\n          name: songDetals.artist\n        }],\n        al: {\n          picUrl: songDetals.cover\n        },\n        id: songDetals.id,\n        // url: songDetals.url,\n        name: songDetals.name,\n        timer: songDetals.timer\n      };\n      playMusic(songDetail, that);\n    },\n\n    //重置试听歌曲\n    resetAudition() {\n      this.$store.commit(\"aplayer/addAUDITION\", {\n        name: \"卡农（经典钢琴版）\",\n        //歌曲名\n        artist: \"dylanf\",\n        //作者\n        // url: songUrlAdd,\n        url: `https://music.163.com/song/media/outer/url?id=478507889.mp3`,\n        cover: \"http://p2.music.126.net/fL7FAeRby1s7JreBqoOKjg==/109951165175371079.jpg\",\n        // lrc: songlrc,\n        id: 478507889,\n        timer: true //试听中添加，防止用户连点消耗性能，在添加播放列表方法中可使用到\n\n      });\n    },\n\n    //获取歌曲下载地址\n    getDownloadUrl(currentMusic) {\n      let musicfilename = currentMusic.name + \" - \" + currentMusic.artist;\n      var that = this;\n      that.$message({\n        type: \"success\",\n        message: \"正在尝试下载\"\n      });\n      let params = {\n        id: currentMusic.id\n      };\n      getDownloadUrl(params).then(res => {\n        // console.log('歌曲下载地址：', res.data)\n        // console.log(\"歌曲下载地址：\", res.data.data.url);\n        // download(res.data.data.url, songName)\n        download(res.data.data[0].url, musicfilename);\n        that.$message({\n          type: \"success\",\n          message: \"开始下载了\"\n        });\n      });\n    },\n\n    //同步vuex正在播放歌曲的数据\n    changeVuexCurrentMusic(musicData) {\n      //同步vuex中的正在播放歌曲的数据\n      this.$store.commit(\"aplayer/changeCurrentPlayMusic\", musicData);\n    }\n\n  }\n};","map":null,"metadata":{},"sourceType":"module"}